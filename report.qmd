---
title: Bridge condition prediction
subtitle: An exploration in Linear Models
author: ["Gonçalo Duarte", "Joana Ferreira", "Lucas Pegas"]
date: today
lang: en-US
strip-comments: true
df-print: paged
  
format:
  html:
    theme: cosmo
    toc: true
    embed-resources: true
    code-tools:
      toggle: false
      source: project_template.qmd
    code-overflow: wrap
    highlight-style: arrow
    smooth-scroll: true
    lightbox: true
    number-sections: true
    tbl-cap-location: top
    other-links:
      - text: Kaggle competition
        href: https://www.kaggle.com/competitions/parking-garage-occupancy
---

```{css}
#| echo: FALSE
body {
  hyphens: auto;
  text-align: justify;
}
```

```{r}
#| context: setup
#| echo: FALSE

# Load packages and set any options here

library(ggplot2)
theme_set(theme_linedraw(base_size = 12))
```
<!-- Definitions for TeX mathematical expressions -->
:::{style="display:none"}
$\def\bs#1{\boldsymbol{#1}}
\def\b#1{\mathbf{#1}}}$
:::

# Introduction

$$\b{y} \sim N_n \left(\b{X} \bs{\beta}, \sigma^2\b{I}\right)$$

For this project we'll evaluate a dataset extracted from the US National Bridge Inspection maintained by the Federal Highways Agency, part of the US Department of Transportation.

Our goals is to analyse how the covariates can explain the bridge condition and propose one or more linear rgression models to predict the response variable for the `predict.csv` dataset.

## Data Set Overview

| Variable | Description |
|----------|-------------|
| Structure_id | Identification key |
| [Urban]{style="color: #7030A0;"} | Whether the bridge is in an urban or rural area |
| [Year]{style="color: #7030A0;"} | The year the bridge was built |
| [Lanes_on]{style="color: #7030A0;"} | Number of traffic lanes on the bridge |
| [AverageDaily]{style="color: #7030A0;"} | The average daily traffic (number of vehicles) |
| [Historic]{style="color: #7030A0;"} | Whether the bridge is historic |
| [Material]{style="color: #7030A0;"} | The dominant material the bridge is made from |
| [Spans]{style="color: #7030A0;"} | Number of spans of the bridge |
| [Length]{style="color: #7030A0;"} | The length of the bridge (m) |
| [Width]{style="color: #7030A0;"} | The width of the bridge (m) |
| [Trucks_percent]{style="color: #7030A0;"} | The percentage of traffic made up of trucks |

# Exploratory data analysis

Here's the summary of the dataset.
```{r}
#| label: data summary
#| fig-cap: Simple summary
group_03 <- read.csv("group_03.csv")


group_03$Urban <- as.factor(group_03$Urban)
group_03$Historic <- as.factor(group_03$Historic)
group_03$Material <- as.factor(group_03$Material)

summary(group_03)
```

### Response variable

Now lets take a look at the response variable to understand how it is distributed.

```{r}
#| label: Condition distribution
#| fig-cap: Response variable distribution
# Basic histogram with normal curve overlay
freq_table <- table(group_03$Condition)
prob_table <- prop.table(freq_table)

# Barplot with normal overlay
barplot(prob_table, 
        main = "Distribution of Condition",
        xlab = "Condition",
        ylab = "Probability",
        col = "lightblue",
        border = "black")

# Add normal curve overlay
x_vals <- as.numeric(names(prob_table))
curve(dnorm(x, mean = mean(group_03$Condition), 
            sd = sd(group_03$Condition)), 
      col = "red", 
      lwd = 2, 
      add = TRUE)

legend("topleft", 
       legend = c("Normal distribution", "Observed frequencies"),
       col = c("red", "lightblue"), 
       lwd = 2,
       pch = c(NA, 15))
```

The `Condition` variable is a numerical measure of the bridge's condition, derived from the ratings attributed to the bridge dec, superstructure and foundations in the most recent inspection. The minimum value observed is 0 and the maximum obtained was 27. 
The response variable is approximately symmetric, with its probability density centered around 20 and exhibiting close to a normal distribution, with slightly heavier tails. 

```{r}
#| label: Condition Skewness
#| fig-cap: Response variable  skewness

library(moments); 
skewness(group_03$Condition)
```

A skewness value of -0.78 confirms mild negative skewness, meaning the response distribution is moderately skewed towards the left. The deviation is not significant and as such the response variable should be compatible with linear with linear regression as long as residuals are well-behaved.

### Numerical variables

Here we inspect the relationship between the numerical covariates and the bridge condition.

```{r}
#| label: Numerical variables scatterplots
#| fig-cap: Numerical variables vs Condition
library(dplyr)
library(tidyr)
library(ggplot2)
db_num <- group_03 |> 
  select(Year, Lanes_on, AverageDaily, Spans, Length, Width, Trucks_percent, Condition)

# Criar scatterplots
db_num |>
  pivot_longer(-Condition, names_to = "Covariate", values_to = "Value") |>
  ggplot(aes(x = Value, y = Condition)) +
  geom_point(alpha = 0.5, size = 1) +
  facet_wrap(~ Covariate, scales = "free_x") +
  theme_linedraw() +
  labs(y = "Condition (Y)", x = "Value")
```

From the scatter plots analysis, we can interpret the relationship between each numerical covariate and the bridge condition. Surprisingly, traffic and usage variables like `AverageDaily` and `Trucks_percent` do not show a strong correlation with the condition, suggesting that traffic volume alone is not a strong predictor. Similarly, physical dimensions such as `Lanes_on` and `Width` display no clear linear relationship, with data appearing heavily clustered. While `Length` and `Spans` exhibit a very weak downward trend, hinting that larger structures might be slightly associated with lower conditions, the pattern is inconclusive. In contrast, the `Year` variable presents the clearest relationship in the entire set, revealing a distinct positive trend where newer bridges tend to have higher condition scores, whereas older bridges (particularly pre-1950) display more low-condition outliers. Therefore, visual inspection strongly suggests that `Year` is the best single candidate for our initial linear model, being the only variable with a distinct linear trend against the response variable.

### Pairwise correlation

Now we'll go over the correlations with the response variable for all the numerical variables.

```{r}
#| label: Pairwise correlation
#| fig-cap: Pairwise correlation with the response variable.

library(corrplot)
cor_matrix <- cor(group_03[, sapply(group_03, is.numeric)])

corrplot(cor_matrix, method = "color", type = "lower", 
         addCoef.col = "black", number.cex = 0.8,
         tl.col = "black", tl.srt = 45, tl.cex = 0.9,
         col = colorRampPalette(c("blue", "white", "red"))(200),
         diag = FALSE)
```

Looking at the correlations with the response variable, `Condition`, we can see that the bridge's `Year` has a significant positive correlation with its condition, indicating older bridges are in a worse condition. We can also see that variables  `Width` and `Lanes_on` are positively correlated which makes sense as more lanes require more width. The average daily traffic is also positively correlated with the bridge width and number of lanes. Apart from this relation we can also see a negative correlation between the `Year` and `Trucks_percent` meaning that older bridges tend to have more truck traffic. This also seems plausible as newer bridges might be built in areas with more commuter trafic. 

### Categorical variables

```{r}
#| label: Categorical variables
#| fig-cap: Categorical variables 


library(ggplot2)

# For Urban
ggplot(group_03, aes(x = Urban, y = Condition)) +
  geom_boxplot(fill = "steelblue") +
  labs(title = "Condition by Location", x = "Urban/Rural", y = "Condition")


# For Historic
ggplot(group_03, aes(x = factor(Historic), y = Condition)) +
  geom_boxplot(fill = "coral") +
  labs(title = "Condition by Historic Status", 
       x = "Historic", y = "Condition")

# For Material
ggplot(group_03, aes(x = factor(Material), y = Condition)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Condition by Material", x = "Material", y = "Condition") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Looking at the `Urban` covariate we can see that both groups have similar medians altough the median condition of urban bridges is slightly higher. Rural bridges show substantially more variability, with more bridges in worse condition.

When it comes to Historic Status we can see that Unknown shows the higher median, altough is the least common category. The `Not Historic`category also shows a high condition score with less variance than the bridges marked as `Possible`. The bridges registered as historic show the lowest median condition score with some highly degraded bridges. These scores indicate that historical status might be an informative categorical predictor.

The `Condition by Material Plot` shows a similar pattern. All the materials have a median condition measure close to 20 with Concrete and "Other" displaying a slightly higher median and Steel and Timber slightly below Timber. 

Concrete and Steel show more variability which makes sense as they're the more used materials by a significant margin.

### Multivariate Analysis

Finally, let's combine our findings. We know `Year` is the strongest numerical predictor and `Material` showed differences in the boxplots. This plot visualizes how they interact.

```{r}
#| label: Year vs Condition by Material
#| fig-cap: Evolution of Bridge Condition over Time colored by Material

ggplot(group_03, aes(x = Year, y = Condition, color = Material)) +
  geom_point(alpha = 0.6) +
  labs(title = "Evolution of Bridge Condition over Time",
       subtitle = "Colored by Bridge Material",
       y = "Condition", x = "Year Built") +
  theme_linedraw()
```
This multivariate visualization reveals a clear interaction between bridge age and material type, confirming that while `Year` is the primary driver of condition—with newer bridges consistently achieving higher ratings—`Material` plays a crucial role in this dynamic. Specifically, post-1980 bridges are predominantly `Concrete` and cluster tightly in the high-condition range (18–25), demonstrating the resilience of modern construction. In contrast, older structures (pre-1950) show significantly more variability: `Timber` bridges, though rare, appear as the most deteriorated category, often falling below a rating of 10, while `Steel` bridges show a wider spread with clear signs of aging. Interestingly, `Masonry` bridges maintain surprisingly decent conditions despite their age, reflecting the natural durability of stone. This analysis suggests that the network's high-condition inventory is driven by modern concrete structures, while low-condition outliers are primarily older steel and timber bridges, reinforcing `Year` as the strongest predictor for our linear model as it proxies for both age and material technology evolution.

## The specification of linear models

Lets start by defining the most basic implementation of the model, that is, including all the covariates while excluding the structure_id.

```{r}
#| label: first model

model <- lm(Condition ~ . - Structure_id, data = group_03)
summary(model)
```

Now lets examine the residuals.

```{r}
#| label: residuals plot for the first model

ggplot(data.frame(fitted = fitted(model), residuals = residuals(model)), 
       aes(x = fitted, y = residuals)) +
  geom_point(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  labs(x = "Fitted Values", y = "Residuals", title = "Residuals vs Fitted")

```


```{r}
par(mfrow=c(2,2))
plot(model)

```

```{r}
par(mfrow=c(1,2))

res <- rstudent(model)
hist(res)
boxplot(res)
```

The histogram of the residuals presents a normal shape with slight negative skewness, which is confirmed by the Q-Q plot, where we only see deviation in the lower values. (Box plot ??? Scale-Location??) The Residuals vs Leverage plot show no observation close to the Cook's Distance at the 0.5 level, which indicate that the outliers are not significant.

**Homocedasticity**

Using the Breusch-Pagan test:

```{r}
lmtest::bptest(model)
```

The homocedasticity null hypothesis is rejected, and so, the residuals may be correlated with the covariates.

```{r}
par(mfrow=c(2,2))

vars <- names(group_03)
vars <- vars[!(vars %in% c("Structure_id", "Condition"))]

for(v in vars) plot(group_03[, v], res, xlab = v)
```

After observing the residuals vs covariates plots we can conclude the following:since the box-plot for Rural and Urban have the same distribution, this suggests that this covariate is insignificant to our model, which is also supported by the p-value (0.40) shown in the model summary; the plot of residuals vs Year show a slight curve towards recent years, which supports the slight upwards curvature presented in the Residuals vs Fitted plot, which may be the source of our linearity problems; both Historic and Material plots have similarly shaped box-plots; the remaining plots present all a slight funnel shape, which once again indicates heterocedasticity, as variance shrinks as covariate values grow.

```{r}
ppcc::ppccTest(rstudent(model), qfn = "qnorm") # Filliben test
```
In `R`, models are specified in a compact symbolic form. From the documentation:

## Model improvements

Building up on the box-plot analysis for the Urban covariate we'll evaluate wether removing that covariate improves model performance.

```{r}

reduced_model <- lm(Condition ~ . - Structure_id - Urban, data = group_03)

anova(reduced_model, model)

```

From these results we conclude that adding `URBAN` doesn't increase the explanatory power of the model so we'll use the reduced model as it is more parsimonious without sacrificing predictive ability.

Define the following models:

a. a first-order model with all covariates except `SEX`;


```{r}
#| label: tbl-basic
#| tbl-cap: Simple demo R table 

dataset <- data.frame(x = 1:10, y = 1:10 + rnorm(10))
dataset
```


```{r}
#| label: fig-basic
#| fig-cap: Simple demo R plot 

ggplot(dataset) + geom_point(aes(x, y), col = "tomato")
```

See [@fig-basic] for an illustration.


# Methods

# Results

# Conclusion

# Appendix I {.unnumbered}